name: test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_call:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-6 \
            libxi6 \
            libxrender1 \
            libxkbcommon0 \
            libgl1 \
            libegl1 \
            libdbus-1-3 \
            libsm6 \
            libice6 \
            xvfb

      - name: Cache Blender 5.0.1
        id: cache-blender
        uses: actions/cache@v4
        with:
          path: blender-dist
          key: ${{ runner.os }}-blender-5.0.1

      - name: Install Blender 5.0.1 (if not cached)
        if: steps.cache-blender.outputs.cache-hit != 'true'
        run: |
          wget https://mirror.clarkson.edu/blender/release/Blender5.0/blender-5.0.1-linux-x64.tar.xz
          tar -xf blender-5.0.1-linux-x64.tar.xz
          mv blender-5.0.1-linux-x64 blender-dist

      - name: Add Blender to Path
        run: echo "$(pwd)/blender-dist" >> $GITHUB_PATH

      - name: Verify Blender Version
        run: blender --version

      - name: Run Tests
        run: |
          # Use xvfb-run to simulate a display for the 3D engine
          # We pass BLENDER_BIN=blender because we added it to the PATH above
          xvfb-run --auto-servernum make test BLENDER_BIN=blender

      - name: Upload Debug Blend Files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blender-5-0-1-test-results
          path: tests/tmp/*.blend

      - name: Upload Manny Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manny-rig-${{ github.run_id }}
          path: tests/tmp/test_result_manny_*.blend
          retention-days: 14

      - name: Upload Quinn Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quinn-rig-${{ github.run_id }}
          path: tests/tmp/test_result_quinn_*.blend
          retention-days: 14